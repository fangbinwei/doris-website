"use strict";(self.webpackChunkselectdb_portal=self.webpackChunkselectdb_portal||[]).push([[81019],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>k});var i=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=i.createContext({}),s=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},m=function(e){var t=s(e.components);return i.createElement(p.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),c=s(n),u=r,k=c["".concat(p,".").concat(u)]||c[u]||d[u]||a;return n?i.createElement(k,o(o({ref:t},m),{},{components:n})):i.createElement(k,o({ref:t},m))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=u;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var s=2;s<a;s++)o[s]=n[s];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}u.displayName="MDXCreateElement"},47578:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>c,frontMatter:()=>a,metadata:()=>l,toc:()=>s});var i=n(87462),r=(n(67294),n(3905));const a={title:"Compile on ARM platform",language:"en"},o=void 0,l={unversionedId:"installing/compilation-arm",id:"version-0.15/installing/compilation-arm",title:"Compile on ARM platform",description:"\x3c!--",source:"@site/versioned_docs/version-0.15/installing/compilation-arm.md",sourceDirName:"installing",slug:"/installing/compilation-arm",permalink:"/docs/0.15/installing/compilation-arm",draft:!1,tags:[],version:"0.15",frontMatter:{title:"Compile on ARM platform",language:"en"},sidebar:"docs",previous:{title:"Compilation",permalink:"/docs/0.15/installing/compilation"},next:{title:"Installation and deployment",permalink:"/docs/0.15/installing/install-deploy"}},p={},s=[{value:"Software and hardware environment",id:"software-and-hardware-environment",level:2},{value:"Compilation tool installation (no network)",id:"compilation-tool-installation-no-network",level:2},{value:"1. Install gcc10",id:"1-install-gcc10",level:3},{value:"2. Install other compilation components",id:"2-install-other-compilation-components",level:3},{value:"3. Compile third-party libraries",id:"3-compile-third-party-libraries",level:3},{value:"4. Compile Doris source code",id:"4-compile-doris-source-code",level:3},{value:"5. FAQ",id:"5-faq",level:3}],m={toc:s};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,i.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"compile-and-run-doris-on-arm64--kylinos"},"Compile and Run Doris on ARM64 + KylinOS."),(0,r.kt)("p",null,"This document describes how to compile Doris on the ARM64 platform."),(0,r.kt)("p",null,"Note that this document is only a guide document. Other errors may occur when compiling in different environments."),(0,r.kt)("h2",{id:"software-and-hardware-environment"},"Software and hardware environment"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"KylinOS version:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"$> cat /etc/.kyinfo\nname=Kylin-Server\nmilestone=10-SP1-Release-Build04-20200711\narch=arm64\nbeta=False\ntime=2020-07-11 17:16:54\ndist_id=Kylin-Server-10-SP1-Release-Build04-20200711-arm64-2020-07-11 17:16:54\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"CPU model"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"$> cat /proc/cpuinfo\nmodel name: Phytium,FT-2000+/64\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Doris version"),(0,r.kt)("p",{parentName:"li"},"commit 68bab73"))),(0,r.kt)("h2",{id:"compilation-tool-installation-no-network"},"Compilation tool installation (no network)"),(0,r.kt)("p",null,"In the example, all tools are installed in the ",(0,r.kt)("inlineCode",{parentName:"p"},"/home/doris/tools/installed/")," directory."),(0,r.kt)("p",null,"Please obtain the required installation package first under network conditions."),(0,r.kt)("h3",{id:"1-install-gcc10"},"1. Install gcc10"),(0,r.kt)("p",null,"Download gcc-10.1.0"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"wget https://mirrors.tuna.tsinghua.edu.cn/gnu/gcc/gcc-10.1.0/gcc-10.1.0.tar.gz\n")),(0,r.kt)("p",null,"After unzipping, check the dependencies in ",(0,r.kt)("inlineCode",{parentName:"p"},"contrib/download_prerequisites")," and download:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"http://gcc.gnu.org/pub/gcc/infrastructure/gmp-6.1.0.tar.bz2\nhttp://gcc.gnu.org/pub/gcc/infrastructure/mpfr-3.1.4.tar.bz2\nhttp://gcc.gnu.org/pub/gcc/infrastructure/mpc-1.0.3.tar.gz\nhttp://gcc.gnu.org/pub/gcc/infrastructure/isl-0.18.tar.bz2\n")),(0,r.kt)("p",null,"Unzip these four dependencies, then move to the gcc-10.1.0 source directory and rename them to gmp, isl, mpc, mpfr."),(0,r.kt)("p",null,"Download and install automake-1.15 (because gcc10 will find automake 1.15 version during compilation)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"https://ftp.gnu.org/gnu/automake/automake-1.15.tar.gz\ntar xzf automake-1.15.tar.gz\n./configure --prefix=/home/doris/tools/installed\nmake && make install\nexport PATH=/home/doris/tools/installed/bin:$PATH\n")),(0,r.kt)("p",null,"Compile GCC10:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cd gcc-10.1.0\n./configure --prefix=/home/doris/tools/installed\nmake -j && make install\n")),(0,r.kt)("p",null,"Compile time is longer."),(0,r.kt)("h3",{id:"2-install-other-compilation-components"},"2. Install other compilation components"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"jdk-8u291-linux-aarch64.tar.gz"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html")),(0,r.kt)("p",{parentName:"li"},"No need to compile, just use it out of the box.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"cmake-3.19.8-Linux-aarch64.tar.gz"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"https://cmake.org/download/")),(0,r.kt)("p",{parentName:"li"},"No need to compile, just use it out of the box")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"apache-maven-3.8.1-bin.tar.gz"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"https://maven.apache.org/download.cgi")),(0,r.kt)("p",{parentName:"li"},"No need to compile, just use it out of the box")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"nodejs 16.3.0"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"https://nodejs.org/dist/v16.3.0/node-v16.3.0-linux-arm64.tar.xz")),(0,r.kt)("p",{parentName:"li"},"No need to compile, just use it out of the box")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"libtool-2.4.6.tar.gz"),(0,r.kt)("p",{parentName:"li"},"For compiling third-party components, although the system may come with libtool, libtool needs to be together with automake, so it is not easy to cause problems."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"https://ftp.gnu.org/gnu/libtool/libtool-2.4.6.tar.gz\ncd libtool-2.4.6/\n./configure --prefix=/home/doris/tools/installed\nmake -j && make install\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"binutils-2.36.tar.xz (obtain bdf.h)"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"https://ftp.gnu.org/gnu/binutils/binutils-2.36.tar.bz2\n./configure --prefix=/home/doris/tools/installed\nmake -j && make install\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Libiberty (for compiling BE)"),(0,r.kt)("p",{parentName:"li"},"The source code of this library is under the source code package of gcc-10.1.0"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"cd gcc-10.1.0/libiberty/\n./configure --prefix=/home/doris/tools/installed\nmake\n")),(0,r.kt)("p",{parentName:"li"},"After compilation, libiberty.a will be generated, which can be moved to the lib64 directory of Doris' thirdparty."))),(0,r.kt)("h3",{id:"3-compile-third-party-libraries"},"3. Compile third-party libraries"),(0,r.kt)("p",null,"Suppose Doris source code is under ",(0,r.kt)("inlineCode",{parentName:"p"},"/home/doris/doris-src/"),"."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Manually download all third-party libraries and place them in the thirdparty/src directory.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add ",(0,r.kt)("inlineCode",{parentName:"p"},"custom_env.sh")," in the Doris source directory and add the following content"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"export DORIS_THIRDPARTY=/home/doris/doris-src/thirdparty/\nexport JAVA_HOME=/home/doris/tools/jdk1.8.0_291/\nexport DORIS_GCC_HOME=/home/doris/tools/installed/\nexport PATCH_COMPILER_RT=true\n")),(0,r.kt)("p",{parentName:"li"},"Pay attention to replace the corresponding directory")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Modify part of the content in build-thirdparty.sh"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Close ",(0,r.kt)("inlineCode",{parentName:"p"},"build_mysql")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"build_libhdfs3")),(0,r.kt)("p",{parentName:"li"},"mysql is no longer needed. However, libhdfs3 does not support arm architecture for the time being, so running Doris in arm does not support direct access to hdfs through libhdfs3, and requires a broker.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add the configure parameter in ",(0,r.kt)("inlineCode",{parentName:"p"},"build_curl"),": ",(0,r.kt)("inlineCode",{parentName:"p"},"--without-libpsl"),". If it is not added, an error may be reported during the linking phase of the final compilation of Doris BE: ",(0,r.kt)("inlineCode",{parentName:"p"},"undefined reference to \u2018psl_is_cookie_domain_acceptable'"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Execute build-thirdparty.sh. Here are only possible errors"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"error: narrowing conversion of'-1' from'int' to'char' [-Wnarrowing]")),(0,r.kt)("p",{parentName:"li"},"  There will be an error when compiling brpc 0.9.7. The solution is to add ",(0,r.kt)("inlineCode",{parentName:"p"},"-Wno-narrowing")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"CMAKE_CXX_FLAGS")," of CMakeLists.txt of brpc. This problem has been fixed in the brpc master code:"),(0,r.kt)("p",{parentName:"li"},"  ",(0,r.kt)("inlineCode",{parentName:"p"},"https://github.com/apache/incubator-brpc/issues/1091"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"libz.a(deflate.o): relocation R_AARCH64_ADR_PREL_PG_HI21 against symbol "),"z_errmsg' which may bind externally can not be used when making a shared object; recompile with -fPIC`"),(0,r.kt)("p",{parentName:"li"},"  There will be errors when compiling brpc 0.9.7, and libcrypto will also report similar errors. The reason is unknown. It seems that under aarch64, brpc needs to link the dynamic zlib and crypto libraries. But when we compile these two third-party libraries, we only compiled .a static files. Solution: Recompile zlib and openssl to generate .so dynamic library:"),(0,r.kt)("p",{parentName:"li"},"  Open ",(0,r.kt)("inlineCode",{parentName:"p"},"build-thirdparty.sh"),", find the ",(0,r.kt)("inlineCode",{parentName:"p"},"build_zlib")," function, and change:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"./configure --prefix=$TP_INSTALL_DIR --static\nJust change to\n./configure --prefix=$TP_INSTALL_DIR\n")),(0,r.kt)("p",{parentName:"li"},"  Find ",(0,r.kt)("inlineCode",{parentName:"p"},"build_openssl")," and comment out the following parts:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"#if [-f $TP_INSTALL_DIR/lib64/libcrypto.so ]; then\n# rm -rf $TP_INSTALL_DIR/lib64/libcrypto.so*\n#fi\n#if [-f $TP_INSTALL_DIR/lib64/libssl.so ]; then\n# rm -rf $TP_INSTALL_DIR/lib64/libssl.so*\n#fi\n")),(0,r.kt)("p",{parentName:"li"},"   Then go to ",(0,r.kt)("inlineCode",{parentName:"p"},"build-thirdparty.sh"),", comment out other ",(0,r.kt)("inlineCode",{parentName:"p"},"build_xxx"),", open only ",(0,r.kt)("inlineCode",{parentName:"p"},"build_zlib")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"build_openssl"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"build_brpc")," and later ",(0,r.kt)("inlineCode",{parentName:"p"},"build_xxx"),". Then re-execute ",(0,r.kt)("inlineCode",{parentName:"p"},"build-thirdparty.sh"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The compilation is stuck at a certain stage."),(0,r.kt)("p",{parentName:"li"},"  Not sure why. Solution: Rerun ",(0,r.kt)("inlineCode",{parentName:"p"},"build-thirdparty.sh"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"build-thirdparty.sh")," can be executed repeatedly."))))),(0,r.kt)("h3",{id:"4-compile-doris-source-code"},"4. Compile Doris source code"),(0,r.kt)("p",null,"Execute ",(0,r.kt)("inlineCode",{parentName:"p"},"sh build.sh"),"."),(0,r.kt)("h3",{id:"5-faq"},"5. FAQ"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"undefined reference to psl_free")," appears when compiling Doris"),(0,r.kt)("p",{parentName:"li"}," libcurl will call libpsl functions, but libpsl is not linked for an unknown reason. Solutions (choose one of the two):"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"Add ",(0,r.kt)("inlineCode",{parentName:"li"},"--without-libpsl")," to the ",(0,r.kt)("inlineCode",{parentName:"li"},"build_curl")," method in ",(0,r.kt)("inlineCode",{parentName:"li"},"thirdparty/build-thirdparty.sh"),", recompile libcurl, and then recompile Doris."),(0,r.kt)("li",{parentName:"ol"},"About line 603 in ",(0,r.kt)("inlineCode",{parentName:"li"},"be/CMakeLists.txt"),", add ",(0,r.kt)("inlineCode",{parentName:"li"},"-lpsl")," after ",(0,r.kt)("inlineCode",{parentName:"li"},"-pthread"),", and then recompile Doris.")))))}c.isMDXComponent=!0}}]);