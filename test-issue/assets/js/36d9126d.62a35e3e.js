"use strict";(self.webpackChunkselectdb_portal=self.webpackChunkselectdb_portal||[]).push([[86018],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>h});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=p(a),m=r,h=u["".concat(s,".").concat(m)]||u[m]||c[m]||i;return a?n.createElement(h,o(o({ref:t},d),{},{components:a})):n.createElement(h,o({ref:t},d))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},38268:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));const i={title:"Spark Load",language:"en"},o=void 0,l={unversionedId:"administrator-guide/load-data/spark-load-manual",id:"version-0.15/administrator-guide/load-data/spark-load-manual",title:"Spark Load",description:"\x3c!--",source:"@site/versioned_docs/version-0.15/administrator-guide/load-data/spark-load-manual.md",sourceDirName:"administrator-guide/load-data",slug:"/administrator-guide/load-data/spark-load-manual",permalink:"/docs/0.15/administrator-guide/load-data/spark-load-manual",draft:!1,tags:[],version:"0.15",frontMatter:{title:"Spark Load",language:"en"},sidebar:"docs",previous:{title:"Sequence Column",permalink:"/docs/0.15/administrator-guide/load-data/sequence-column-manual"},next:{title:"Stream load",permalink:"/docs/0.15/administrator-guide/load-data/stream-load-manual"}},s={},p=[{value:"Applicable scenarios",id:"applicable-scenarios",level:2},{value:"Explanation of terms",id:"explanation-of-terms",level:2},{value:"Basic principles",id:"basic-principles",level:2},{value:"Basic process",id:"basic-process",level:3},{value:"Global dictionary",id:"global-dictionary",level:2},{value:"Applicable scenarios",id:"applicable-scenarios-1",level:3},{value:"Build process",id:"build-process",level:3},{value:"Data preprocessing (DPP)",id:"data-preprocessing-dpp",level:2},{value:"Basic process",id:"basic-process-1",level:3},{value:"Basic operation",id:"basic-operation",level:2},{value:"Configure ETL cluster",id:"configure-etl-cluster",level:3},{value:"Create resource",id:"create-resource",level:4},{value:"Show resources",id:"show-resources",level:4},{value:"Resource privilege",id:"resource-privilege",level:4},{value:"Configure spark client",id:"configure-spark-client",level:3},{value:"Configure SPARK_HOME environment variable",id:"configure-spark_home-environment-variable",level:4},{value:"Configure spark dependencies",id:"configure-spark-dependencies",level:4},{value:"Configure yarn client",id:"configure-yarn-client",level:3},{value:"Configure the yarn client path",id:"configure-the-yarn-client-path",level:4},{value:"Create load",id:"create-load",level:3},{value:"Label",id:"label",level:4},{value:"Data description parameters",id:"data-description-parameters",level:4},{value:"Load job parameters",id:"load-job-parameters",level:4},{value:"Spark resource parameters",id:"spark-resource-parameters",level:4},{value:"Load when data source is hive table",id:"load-when-data-source-is-hive-table",level:4},{value:"Load process to build global dictionary",id:"load-process-to-build-global-dictionary",level:4},{value:"Show load",id:"show-load",level:3},{value:"View spark launcher commit log",id:"view-spark-launcher-commit-log",level:3},{value:"cancel load",id:"cancel-load",level:3},{value:"Related system configuration",id:"related-system-configuration",level:2},{value:"FE configuration",id:"fe-configuration",level:3},{value:"Best practices",id:"best-practices",level:2},{value:"Application scenarios",id:"application-scenarios",level:3},{value:"FAQ",id:"faq",level:2}],d={toc:p};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"spark-load"},"Spark Load"),(0,r.kt)("p",null,"Spark load realizes the preprocessing of load data by spark, improves the performance of loading large amount of Doris data and saves the computing resources of Doris cluster. It is mainly used for the scene of initial migration and large amount of data imported into Doris."),(0,r.kt)("p",null,"Spark load is an asynchronous load method. Users need to create spark type load job by MySQL protocol and view the load results by ",(0,r.kt)("inlineCode",{parentName:"p"},"show load"),"."),(0,r.kt)("h2",{id:"applicable-scenarios"},"Applicable scenarios"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The source data is in a file storage system that spark can access, such as HDFS.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The data volume ranges from tens of GB to TB."))),(0,r.kt)("h2",{id:"explanation-of-terms"},"Explanation of terms"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Frontend (FE): metadata and scheduling node of Doris system. In the load process, it is mainly responsible for the scheduling of load jobs.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Backend (be): the computing and storage node of Doris system. In the load process, it is mainly responsible for data writing and storage.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Spark ETL: in the load process, it is mainly responsible for ETL of data, including global dictionary construction (bitmap type), partition, sorting, aggregation, etc.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Broker: broker is an independent stateless process. It encapsulates the file system interface and provides the ability of Doris to read the files in the remote storage system.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Global dictionary: it stores the data structure from the original value to the coded value. The original value can be any data type, while the encoded value is an integer. The global dictionary is mainly used in the scene of precise de duplication precomputation."))),(0,r.kt)("h2",{id:"basic-principles"},"Basic principles"),(0,r.kt)("h3",{id:"basic-process"},"Basic process"),(0,r.kt)("p",null,"The user submits spark type load job by MySQL client, Fe records metadata and returns that the user submitted successfully."),(0,r.kt)("p",null,"The implementation of spark load task is mainly divided into the following five stages."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Fe schedules and submits ETL tasks to spark cluster for execution.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Spark cluster executes ETL to complete the preprocessing of load data. It includes global dictionary building (bitmap type), partitioning, sorting, aggregation, etc.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"After the ETL task is completed, Fe obtains the data path of each partition that has been preprocessed, and schedules the related be to execute the push task.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Be reads data through broker and converts it into Doris underlying storage format.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Fe schedule the effective version and complete the load job."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"                 +\n                 | 0. User create spark load job\n            +----v----+\n            |   FE    |---------------------------------+\n            +----+----+                                 |\n                 | 3. FE send push tasks                |\n                 | 5. FE publish version                |\n    +------------+------------+                         |\n    |            |            |                         |\n+---v---+    +---v---+    +---v---+                     |\n|  BE   |    |  BE   |    |  BE   |                     |1. FE submit Spark ETL job\n+---^---+    +---^---+    +---^---+                     |\n    |4. BE push with broker   |                         |\n+---+---+    +---+---+    +---+---+                     |\n|Broker |    |Broker |    |Broker |                     |\n+---^---+    +---^---+    +---^---+                     |\n    |            |            |                         |\n+---+------------+------------+---+ 2.ETL +-------------v---------------+\n|               HDFS              +-------\x3e       Spark cluster         |\n|                                 <-------+                             |\n+---------------------------------+       +-----------------------------+\n\n")),(0,r.kt)("h2",{id:"global-dictionary"},"Global dictionary"),(0,r.kt)("h3",{id:"applicable-scenarios-1"},"Applicable scenarios"),(0,r.kt)("p",null,"At present, the bitmap column in Doris is implemented using the class library '",(0,r.kt)("inlineCode",{parentName:"p"},"roaingbitmap"),"', while the input data type of '",(0,r.kt)("inlineCode",{parentName:"p"},"roaringbitmap"),"' can only be integer. Therefore, if you want to pre calculate the bitmap column in the import process, you need to convert the type of input data to integer."),(0,r.kt)("p",null,"In the existing Doris import process, the data structure of global dictionary is implemented based on hive table, which stores the mapping from original value to encoded value."),(0,r.kt)("h3",{id:"build-process"},"Build process"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Read the data from the upstream data source and generate a hive temporary table, which is recorded as ",(0,r.kt)("inlineCode",{parentName:"p"},"hive_table"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Extract the de duplicated values of the fields to be de duplicated from the ",(0,r.kt)("inlineCode",{parentName:"p"},"hive_table"),", and generate a new hive table, which is marked as ",(0,r.kt)("inlineCode",{parentName:"p"},"distinct_value_table"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a new global dictionary table named ",(0,r.kt)("inlineCode",{parentName:"p"},"dict_table"),"; one column is the original value, and the other is the encoded value.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Left join the ",(0,r.kt)("inlineCode",{parentName:"p"},"distinct_value_table")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"dict_table"),", calculate the new de duplication value set, and then code this set with window function. At this time, the original value of the de duplication column will have one more column of encoded value. Finally, the data of these two columns will be written back to ",(0,r.kt)("inlineCode",{parentName:"p"},"dict_table"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Join the ",(0,r.kt)("inlineCode",{parentName:"p"},"dict_table")," with the ",(0,r.kt)("inlineCode",{parentName:"p"},"hive_table")," to replace the original value in the ",(0,r.kt)("inlineCode",{parentName:"p"},"hive_table")," with the integer encoded value.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"hive_table")," will be read by the next data preprocessing process and imported into Doris after calculation."))),(0,r.kt)("h2",{id:"data-preprocessing-dpp"},"Data preprocessing (DPP)"),(0,r.kt)("h3",{id:"basic-process-1"},"Basic process"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Read data from the data source. The upstream data source can be HDFS file or hive table.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Map the read data, calculate the expression, and generate the bucket field ",(0,r.kt)("inlineCode",{parentName:"p"},"bucket_id")," according to the partition information.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Generate rolluptree according to rollup metadata of Doris table.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Traverse rolluptree to perform hierarchical aggregation. The rollup of the next level can be calculated from the rollup of the previous level.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"After each aggregation calculation, the data will be calculated according to the ",(0,r.kt)("inlineCode",{parentName:"p"},"bucket_id"),"is divided into buckets and then written into HDFS.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Subsequent brokers will pull the files in HDFS and import them into Doris be."))),(0,r.kt)("h2",{id:"basic-operation"},"Basic operation"),(0,r.kt)("h3",{id:"configure-etl-cluster"},"Configure ETL cluster"),(0,r.kt)("p",null,"As an external computing resource, spark is used to complete ETL work in Doris. In the future, there may be other external resources that will be used in Doris, such as spark / GPU for query, HDFS / S3 for external storage, MapReduce for ETL, etc. Therefore, we introduce resource management to manage these external resources used by Doris."),(0,r.kt)("p",null,"Before submitting the spark import task, you need to configure the spark cluster that performs the ETL task."),(0,r.kt)("p",null,"Grammar:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'-- create spark resource\nCREATE EXTERNAL RESOURCE resource_name\nPROPERTIES\n(\n  type = spark,\n  spark_conf_key = spark_conf_value,\n  working_dir = path,\n  broker = broker_name,\n  broker.property_key = property_value\n)\n\n-- drop spark resource\nDROP RESOURCE resource_name\n\n-- show resources\nSHOW RESOURCES\nSHOW PROC "/resources"\n\n-- privileges\nGRANT USAGE_PRIV ON RESOURCE resource_name TO user_identity\nGRANT USAGE_PRIV ON RESOURCE resource_name TO ROLE role_name\n\nREVOKE USAGE_PRIV ON RESOURCE resource_name FROM user_identity\nREVOKE USAGE_PRIV ON RESOURCE resource_name FROM ROLE role_name\n')),(0,r.kt)("h4",{id:"create-resource"},"Create resource"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"resource_name")," is the name of the spark resource configured in Doris."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Properties")," are the parameters related to spark resources, as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"type"),": resource type, required. Currently, only spark is supported.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Spark related parameters are as follows:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"spark.master"),": required, yarn is supported at present, ",(0,r.kt)("inlineCode",{parentName:"p"},"spark://host:port"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"spark.submit.deployMode"),": the deployment mode of Spark Program. It is required and supports cluster and client.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"spark.hadoop.yarn.resourcemanager.address"),": required when master is yarn.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"spark.hadoop.fs.defaultfs"),": required when master is yarn.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Other parameters are optional, refer to ",(0,r.kt)("inlineCode",{parentName:"p"},"http://spark.apache.org/docs/latest/configuration.html"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"working_dir"),": directory used by ETL. Spark is required when used as an ETL resource. For example: ",(0,r.kt)("inlineCode",{parentName:"p"},"hdfs://host :port/tmp/doris"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"broker"),": the name of the broker. Spark is required when used as an ETL resource. You need to use the 'alter system add broker' command to complete the configuration in advance.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"broker.property_key"),": the authentication information that the broker needs to specify when reading the intermediate file generated by ETL."))),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'-- yarn cluster \u6a21\u5f0f\nCREATE EXTERNAL RESOURCE "spark0"\nPROPERTIES\n(\n  "type" = "spark",\n  "spark.master" = "yarn",\n  "spark.submit.deployMode" = "cluster",\n  "spark.jars" = "xxx.jar,yyy.jar",\n  "spark.files" = "/tmp/aaa,/tmp/bbb",\n  "spark.executor.memory" = "1g",\n  "spark.yarn.queue" = "queue0",\n  "spark.hadoop.yarn.resourcemanager.address" = "127.0.0.1:9999",\n  "spark.hadoop.fs.defaultFS" = "hdfs://127.0.0.1:10000",\n  "working_dir" = "hdfs://127.0.0.1:10000/tmp/doris",\n  "broker" = "broker0",\n  "broker.username" = "user0",\n  "broker.password" = "password0"\n);\n\n-- spark standalone client \u6a21\u5f0f\nCREATE EXTERNAL RESOURCE "spark1"\nPROPERTIES\n(\n  "type" = "spark",\n  "spark.master" = "spark://127.0.0.1:7777",\n  "spark.submit.deployMode" = "client",\n  "working_dir" = "hdfs://127.0.0.1:10000/tmp/doris",\n  "broker" = "broker1"\n);\n')),(0,r.kt)("h4",{id:"show-resources"},"Show resources"),(0,r.kt)("p",null,"Ordinary accounts can only see the resources that they have ",(0,r.kt)("inlineCode",{parentName:"p"},"USAGE_PRIV")," to use."),(0,r.kt)("p",null,"The root and admin accounts can see all the resources."),(0,r.kt)("h4",{id:"resource-privilege"},"Resource privilege"),(0,r.kt)("p",null,"Resource permissions are managed by grant revoke. Currently, only ",(0,r.kt)("inlineCode",{parentName:"p"},"USAGE_PRIV")," permission is supported."),(0,r.kt)("p",null,"You can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"USAGE_PRIV")," permission is given to a user or a role, and the role is used the same as before."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'-- Grant permission to the spark0 resource to user user0\n\nGRANT USAGE_PRIV ON RESOURCE "spark0" TO "user0"@"%";\n\n\n-- Grant permission to the spark0 resource to role ROLE0\n\nGRANT USAGE_PRIV ON RESOURCE "spark0" TO ROLE "role0";\n\n\n-- Grant permission to all resources to user user0\n\nGRANT USAGE_PRIV ON RESOURCE * TO "user0"@"%";\n\n\n-- Grant permission to all resources to role ROLE0\n\nGRANT USAGE_PRIV ON RESOURCE * TO ROLE "role0";\n\n\n-- Revoke the spark0 resource permission of user user0\n\nREVOKE USAGE_PRIV ON RESOURCE "spark0" FROM "user0"@"%";\n\n')),(0,r.kt)("h3",{id:"configure-spark-client"},"Configure spark client"),(0,r.kt)("p",null,"The Fe submits the spark task by executing the spark submit command. Therefore, it is necessary to configure the spark client for Fe. It is recommended to use the official version of spark 2 above 2.4.3, ",(0,r.kt)("a",{parentName:"p",href:"https://archive.apache.org/dist/spark/"},"download spark here"),". After downloading, please follow the steps to complete the following configuration."),(0,r.kt)("h4",{id:"configure-spark_home-environment-variable"},"Configure SPARK_HOME environment variable"),(0,r.kt)("p",null,"Place the spark client on the same machine as Fe and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"spark_home_default_dir")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"fe.conf"),". This configuration item defaults to the ",(0,r.kt)("inlineCode",{parentName:"p"},"fe/lib/spark2x")," path. This config cannot be empty."),(0,r.kt)("h4",{id:"configure-spark-dependencies"},"Configure spark dependencies"),(0,r.kt)("p",null,"Package all jar packages in jars folder under spark client root path into a zip file, and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"spark_resource_patj")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"fe.conf")," as this zip file's path."),(0,r.kt)("p",null,"When the spark load task is submitted, this zip file will be uploaded to the remote repository, and the default repository path will be hung in ",(0,r.kt)("inlineCode",{parentName:"p"},"working_dir/{cluster_ID}")," directory named as ",(0,r.kt)("inlineCode",{parentName:"p"},"__spark_repository__{resource_name}"),", which indicates that a resource in the cluster corresponds to a remote warehouse. The directory structure of the remote warehouse is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"__spark_repository__spark0/\n    |-__archive_1.0.0/\n    |        |-__lib_990325d2c0d1d5e45bf675e54e44fb16_spark-dpp-1.0.0-jar-with-dependencies.jar\n    |        |-__lib_7670c29daf535efe3c9b923f778f61fc_spark-2x.zip\n    |-__archive_1.1.0/\n    |        |-__lib_64d5696f99c379af2bee28c1c84271d5_spark-dpp-1.1.0-jar-with-dependencies.jar\n    |        |-__lib_1bbb74bb6b264a270bc7fca3e964160f_spark-2x.zip\n    |-__archive_1.2.0/\n    |        |-...\n")),(0,r.kt)("p",null,"In addition to spark dependency (named by ",(0,r.kt)("inlineCode",{parentName:"p"},"spark-2x.zip")," by default), Fe will also upload DPP's dependency package to the remote repository. If all the dependency files submitted by spark load already exist in the remote repository, then there is no need to upload dependency, saving the time of repeatedly uploading a large number of files each time."),(0,r.kt)("h3",{id:"configure-yarn-client"},"Configure yarn client"),(0,r.kt)("p",null,"The Fe obtains the running application status and kills the application by executing the yarn command. Therefore, you need to configure the yarn client for Fe. It is recommended to use the official version of Hadoop above 2.5.2, ",(0,r.kt)("a",{parentName:"p",href:"https://archive.apache.org/dist/hadoop/common/"},"download hadoop"),". After downloading, please follow the steps to complete the following configuration."),(0,r.kt)("h4",{id:"configure-the-yarn-client-path"},"Configure the yarn client path"),(0,r.kt)("p",null,"Place the downloaded yarn client in the same machine as Fe, and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn_client_path")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"fe.conf")," as the executable file of yarn, which is set as the ",(0,r.kt)("inlineCode",{parentName:"p"},"fe/lib/yarn-client/hadoop/bin/yarn")," by default."),(0,r.kt)("p",null,"(optional) when Fe obtains the application status or kills the application through the yarn client, the configuration files required for executing the yarn command will be generated by default in the ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/yarn-config")," path in the Fe root directory. This path can be configured by configuring ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn-config-dir")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"fe.conf"),". The currently generated configuration yarn config files include ",(0,r.kt)("inlineCode",{parentName:"p"},"core-site.xml")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn-site.xml"),"."),(0,r.kt)("h3",{id:"create-load"},"Create load"),(0,r.kt)("p",null,"Grammar:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"LOAD LABEL load_label\n    (data_desc, ...)\n    WITH RESOURCE resource_name resource_properties\n    [PROPERTIES (key1=value1, ... )]\n\n* load_label:\n    db_name.label_name\n\n* data_desc:\n    DATA INFILE ('file_path', ...)\n    [NEGATIVE]\n    INTO TABLE tbl_name\n    [PARTITION (p1, p2)]\n    [COLUMNS TERMINATED BY separator ]\n    [(col1, ...)]\n    [SET (k1=f1(xx), k2=f2(xx))]\n    [WHERE predicate]\n\n* resource_properties:\n    (key2=value2, ...)\n")),(0,r.kt)("p",null,"Example 1: when the upstream data source is HDFS file"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'LOAD LABEL db1.label1\n(\n    DATA INFILE("hdfs://abc.com:8888/user/palo/test/ml/file1")\n    INTO TABLE tbl1\n    COLUMNS TERMINATED BY ","\n    (tmp_c1,tmp_c2)\n    SET\n    (\n        id=tmp_c2,\n        name=tmp_c1\n    ),\n    DATA INFILE("hdfs://abc.com:8888/user/palo/test/ml/file2")\n    INTO TABLE tbl2\n    COLUMNS TERMINATED BY ","\n    (col1, col2)\n    where col1 > 1\n)\nWITH RESOURCE \'spark0\'\n(\n    "spark.executor.memory" = "2g",\n    "spark.shuffle.compress" = "true"\n)\nPROPERTIES\n(\n    "timeout" = "3600"\n);\n\n')),(0,r.kt)("p",null,"Example 2: when the upstream data source is hive table"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'step 1:\u65b0\u5efahive\u5916\u90e8\u8868\nCREATE EXTERNAL TABLE hive_t1\n(\n    k1 INT,\n    K2 SMALLINT,\n    k3 varchar(50),\n    uuid varchar(100)\n)\nENGINE=hive\nproperties\n(\n"database" = "tmp",\n"table" = "t1",\n"hive.metastore.uris" = "thrift://0.0.0.0:8080"\n);\n\nstep 2: \u63d0\u4ea4load\u547d\u4ee4\nLOAD LABEL db1.label1\n(\n    DATA FROM TABLE hive_t1\n    INTO TABLE tbl1\n    (k1,k2,k3)\n    SET\n    (\n        uuid=bitmap_dict(uuid)\n    )\n)\nWITH RESOURCE \'spark0\'\n(\n    "spark.executor.memory" = "2g",\n    "spark.shuffle.compress" = "true"\n)\nPROPERTIES\n(\n    "timeout" = "3600"\n);\n\n')),(0,r.kt)("p",null,"You can view the details syntax about creating load by input ",(0,r.kt)("inlineCode",{parentName:"p"},"help spark load"),". This paper mainly introduces the parameter meaning and precautions in the creation and load syntax of spark load."),(0,r.kt)("h4",{id:"label"},"Label"),(0,r.kt)("p",null,"Identification of the import task. Each import task has a unique label within a single database. The specific rules are consistent with ",(0,r.kt)("inlineCode",{parentName:"p"},"broker load"),"."),(0,r.kt)("h4",{id:"data-description-parameters"},"Data description parameters"),(0,r.kt)("p",null,"Currently, the supported data sources are CSV and hive table. Other rules are consistent with ",(0,r.kt)("inlineCode",{parentName:"p"},"broker load"),"."),(0,r.kt)("h4",{id:"load-job-parameters"},"Load job parameters"),(0,r.kt)("p",null,"Load job parameters mainly refer to the ",(0,r.kt)("inlineCode",{parentName:"p"},"opt_properties")," in the spark load. Load job parameters are applied to the entire load job. The rules are consistent with ",(0,r.kt)("inlineCode",{parentName:"p"},"broker load"),"."),(0,r.kt)("h4",{id:"spark-resource-parameters"},"Spark resource parameters"),(0,r.kt)("p",null,"Spark resources need to be configured into the Doris system in advance, and users should be given ",(0,r.kt)("inlineCode",{parentName:"p"},"USAGE_PRIV"),". Spark load can only be used after priv permission."),(0,r.kt)("p",null,"When users have temporary requirements, such as adding resources for tasks and modifying spark configs, you can set them here. The settings only take effect for this task and do not affect the existing configuration in the Doris cluster."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'WITH RESOURCE \'spark0\'\n(\n  "spark.driver.memory" = "1g",\n  "spark.executor.memory" = "3g"\n)\n')),(0,r.kt)("h4",{id:"load-when-data-source-is-hive-table"},"Load when data source is hive table"),(0,r.kt)("p",null,"At present, if you want to use hive table as a data source in the import process, you need to create an external table of type hive,"),(0,r.kt)("p",null,"Then you can specify the table name of the external table when submitting the Load command."),(0,r.kt)("h4",{id:"load-process-to-build-global-dictionary"},"Load process to build global dictionary"),(0,r.kt)("p",null,"The data type applicable to the aggregate columns of the Doris table is of type bitmap."),(0,r.kt)("p",null,"In the load command, you can specify the field to build a global dictionary. The format is: '",(0,r.kt)("inlineCode",{parentName:"p"},"doris field name=bitmap_dict(hive_table field name)")),(0,r.kt)("p",null,"It should be noted that the construction of global dictionary is supported only when the upstream data source is hive table."),(0,r.kt)("h3",{id:"show-load"},"Show load"),(0,r.kt)("p",null,"Spark load is asynchronous just like broker load, so the user must create the load label record and use label in the ",(0,r.kt)("strong",{parentName:"p"},"show load command to view the load result"),". The show load command is common in all load types. The specific syntax can be viewed by executing help show load."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'mysql> show load order by createtime desc limit 1\\G\n*************************** 1. row ***************************\n         JobId: 76391\n         Label: label1\n         State: FINISHED\n      Progress: ETL:100%; LOAD:100%\n          Type: SPARK\n       EtlInfo: unselected.rows=4; dpp.abnorm.ALL=15; dpp.norm.ALL=28133376\n      TaskInfo: cluster:cluster0; timeout(s):10800; max_filter_ratio:5.0E-5\n      ErrorMsg: N/A\n    CreateTime: 2019-07-27 11:46:42\n  EtlStartTime: 2019-07-27 11:46:44\n EtlFinishTime: 2019-07-27 11:49:44\n LoadStartTime: 2019-07-27 11:49:44\nLoadFinishTime: 2019-07-27 11:50:16\n           URL: http://1.1.1.1:8089/proxy/application_1586619723848_0035/\n    JobDetails: {"ScannedRows":28133395,"TaskNumber":1,"FileNumber":1,"FileSize":200000}\n')),(0,r.kt)("p",null,"Refer to broker load for the meaning of parameters in the returned result set. The differences are as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"State")),(0,r.kt)("p",null,"The current phase of the load job. After the job is submitted, the status is pending. After the spark ETL is submitted, the status changes to ETL. After ETL is completed, Fe schedules be to execute push operation, and the status changes to finished after the push is completed and the version takes effect."),(0,r.kt)("p",null,"There are two final stages of the load job: cancelled and finished. When the load job is in these two stages, the load is completed. Among them, cancelled is load failure, finished is load success."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Progress")),(0,r.kt)("p",null,"Progress description of the load job. There are two kinds of progress: ETL and load, corresponding to the two stages of the load process, ETL and loading."),(0,r.kt)("p",null,"The progress range of load is 0 ~ 100%."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Load progress = the number of tables that have completed all replica imports / the total number of tables in this import task * 100%")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"If all load tables are loaded, the progress of load is 99%"),", the load enters the final effective stage. After the whole load is completed, the load progress will be changed to 100%."),(0,r.kt)("p",null,"The load progress is not linear. Therefore, if the progress does not change over a period of time, it does not mean that the load is not in execution."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Type")),(0,r.kt)("p",null,"Type of load job. Spark load is spark."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"CreateTime/EtlStartTime/EtlFinishTime/LoadStartTime/LoadFinishTime")),(0,r.kt)("p",null,"These values represent the creation time of the load, the start time of the ETL phase, the completion time of the ETL phase, the start time of the loading phase, and the completion time of the entire load job."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"JobDetails")),(0,r.kt)("p",null,"Display the detailed running status of some jobs, which will be updated when ETL ends. It includes the number of loaded files, the total size (bytes), the number of subtasks, the number of processed original lines, etc."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},'{"ScannedRows":139264,"TaskNumber":1,"FileNumber":1,"FileSize":940754064}')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"URL")),(0,r.kt)("p",null,"Copy this url to the browser and jump to the web interface of the corresponding application."),(0,r.kt)("h3",{id:"view-spark-launcher-commit-log"},"View spark launcher commit log"),(0,r.kt)("p",null,"Sometimes users need to view the detailed logs generated during the spark submission process. The logs are saved in the ",(0,r.kt)("inlineCode",{parentName:"p"},"log/spark_launcher_log")," under the Fe root directory named as ",(0,r.kt)("inlineCode",{parentName:"p"},"spark_launcher_{load_job_id}_{label}.log"),". The log will be saved in this directory for a period of time. When the load information in Fe metadata is cleaned up, the corresponding log will also be cleaned. The default saving log time is 3 days."),(0,r.kt)("h3",{id:"cancel-load"},"cancel load"),(0,r.kt)("p",null,"When the spark load job status is not cancelled or finished, it can be manually cancelled by the user. When canceling, you need to specify the label to cancel the load job. The syntax of the cancel load command can be viewed by executing ",(0,r.kt)("inlineCode",{parentName:"p"},"help cancel load"),". "),(0,r.kt)("h2",{id:"related-system-configuration"},"Related system configuration"),(0,r.kt)("h3",{id:"fe-configuration"},"FE configuration"),(0,r.kt)("p",null,"The following configuration belongs to the system level configuration of spark load, that is, the configuration for all spark load import tasks. Mainly through modification",(0,r.kt)("inlineCode",{parentName:"p"},"fe.conf")," to modify the configuration value."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"enable_spark_load"))),(0,r.kt)("p",null,"Open spark load and create resource. The default value is false. This feature is turned off."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"spark_load_default_timeout_second"))),(0,r.kt)("p",null,"The default timeout for tasks is 259200 seconds (3 days)."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"spark_home_default_dir"))),(0,r.kt)("p",null,"Spark client path (",(0,r.kt)("inlineCode",{parentName:"p"},"Fe/lib/spark2x"),")."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"spark_resource_path"))),(0,r.kt)("p",null,"The path of the packaged spark dependent file (empty by default)."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"spark_launcher_log_dir"))),(0,r.kt)("p",null,"The directory where the spark client's commit log is stored (",(0,r.kt)("inlineCode",{parentName:"p"},"Fe/log/spark)_launcher_log"),"\uff09."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"yarn_client_path"))),(0,r.kt)("p",null,"The path of the yarn binary executable file (`Fe/lib/yarn-client/Hadoop/bin/yarn')."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"yarn_config_dir"))),(0,r.kt)("p",null,"The path to generate the yarn configuration file (",(0,r.kt)("inlineCode",{parentName:"p"},"Fe/lib/yarn-config"),")."),(0,r.kt)("h2",{id:"best-practices"},"Best practices"),(0,r.kt)("h3",{id:"application-scenarios"},"Application scenarios"),(0,r.kt)("p",null,"The most suitable scenario to use spark load is that the raw data is in the file system (HDFS), and the amount of data is tens of GB to TB. Stream load or broker load is recommended for small amount of data."),(0,r.kt)("h2",{id:"faq"},"FAQ"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When using spark load, the ",(0,r.kt)("inlineCode",{parentName:"li"},"HADOOP_CONF_DIR")," environment variable is no set in the ",(0,r.kt)("inlineCode",{parentName:"li"},"spark-env.sh"),".")),(0,r.kt)("p",null,"If the ",(0,r.kt)("inlineCode",{parentName:"p"},"HADOOP_CONF_DIR")," environment variable is not set, the error ",(0,r.kt)("inlineCode",{parentName:"p"},"When running with master 'yarn' either HADOOP_CONF_DIR or YARN_CONF_DIR must be set in the environment")," will be reported."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When using spark load, the ",(0,r.kt)("inlineCode",{parentName:"li"},"spark_home_default_dir")," does not specify correctly.")),(0,r.kt)("p",null,"The spark submit command is used when submitting a spark job. If ",(0,r.kt)("inlineCode",{parentName:"p"},"spark_home_default_dir")," is set incorrectly, an error ",(0,r.kt)("inlineCode",{parentName:"p"},"Cannot run program 'xxx/bin/spark_submit', error = 2, no such file or directory")," will be reported."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When using spark load, ",(0,r.kt)("inlineCode",{parentName:"li"},"spark_resource_path")," does not point to the packaged zip file.")),(0,r.kt)("p",null,"If ",(0,r.kt)("inlineCode",{parentName:"p"},"spark_resource_path")," is not set correctly. An error ",(0,r.kt)("inlineCode",{parentName:"p"},"file XXX/jars/spark-2x.zip")," does not exist will be reported."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When using spark load ",(0,r.kt)("inlineCode",{parentName:"li"},"yarn_client_path")," does not point to a executable file of yarn.")),(0,r.kt)("p",null,"If ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn_client_path")," is not set correctly. An error ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn client does not exist in path: XXX/yarn-client/hadoop/bin/yarn")," will be reported."))}u.isMDXComponent=!0}}]);